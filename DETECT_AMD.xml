<include>
  <!-- Contexto principal para manejo de audio stream y transferencias -->
  <context name="DETECT_AMD_PRO">

    <!-- Extension: Manejo de llamadas con audio stream automático -->
    <extension name="audio_stream_handler">
      <condition field="destination_number" expression="^2222$">
        <!-- Si todo está bien, continuar -->
        <action application="set" data="write_codec=L16@16000h"/>
        <action application="set" data="record_sample_rate=16000"/>
        <action application="set" data="record_path=/var/www/BestFS_Dialer/recordings/${strftime(%Y-%m-%d-%H-%M-%S)}_${caller_id_number}.wav"/>
        <action application="record_session" data="${record_path}"/>
        <action application="log" data="INFO [${campaign_name} Llamada recibida para ${origination_caller_id_number} con UUID ${valid_uuid}"/>
        <action application="set" data="campaign_name=${campaign_name}"/>
        <action application="set" data="numero=${origination_caller_id_number}"/>
        <action application="set" data="wss_url=wss://localhost:8080/audio?uuid=${uuid}&numero=${numero}&campaign=${campaign_name}"/>
        <action application="log" data="INFO [${campaign_name}] WebSocket URL construida: ${wss_url}"/>
        <!-- Manejo de error en comando system -->
        <action application="log" data="INFO [${campaign_name}] Iniciando audio stream para ${numero}..."/>
        <action application="system" data="fs_cli -p1Pl}0F~~801l -x 'uuid_audio_stream ${uuid} start ${wss_url} mono 16000'"/>
        <action application="log" data="ERR Si el audio stream no inicia, revisar parámetros y conexión WebSocket"/>
        <action application="set" data="execute_on_answer=system fs_cli -p1Pl}0F~~801l -x 'uuid_audio_stream ${uuid} stop'"/>
        <action application="log" data="INFO [${campaign_name}] Transferencia automática a 9999@${campaign_name} en llamada contestada"/>
        <action application="log" data="INFO [${campaign_name}] Audio stream iniciado para ${numero}"/>
        <action application="log" data="INFO [${campaign_name}] Manteniendo llamada ${numero} en park..."/>
        <action application="park"/>
      </condition>
    </extension>

    <!-- Extension: Transferencias desde otros contextos -->
    <extension name="transfer_handler">
      <condition field="destination_number" expression="^9999$">
        <!-- Validación de UUID -->
        <action application="eval" data="${uuid} == ''"/>
        <action application="log" data="ERR UUID vacío en transferencia"/>
        <action application="hangup"/>
        <!-- Log de transferencia -->
        <action application="log" data="INFO [${origination_campaign_name}] Llamada transferida UUID ${uuid}"/>
        <!-- Detener audio stream -->
        <action application="log" data="INFO [${origination_campaign_name}] Deteniendo audio stream..."/>
        <action application="system" data="fs_cli -p1Pl}0F~~801l -x 'uuid_audio_stream ${uuid} stop'"/>
        <action application="log" data="ERR Si el audio stream no se detiene, revisar UUID y estado de llamada"/>
        <!-- Mantener llamada en park -->
        <action application="log" data="INFO [${origination_campaign_name}] Transferencia completada, manteniendo en park"/>
        <action application="park"/>
      </condition>
    </extension>

  </context>
</include>

<include>
  <context name="Test2">
      
    <!-- Extensión inicial: contestar y enviar al menú -->
    <extension name="execute_on_answer">
      <condition field="destination_number" expression="^9999$">
        <action application="set" data="call_uuid=${uuid}"/>
        <action application="answer"/>
        <action application="sleep" data="1000"/>
        <action application="transfer" data="1000 XML Test2"/>
      </condition>
    </extension>

    <!-- Menú principal -->
    <extension name="ivr_main-Test2">
      <condition field="destination_number" expression="^1000$">

        <action application="play_and_get_digits" 
                data="1 1 3 3000 # /var/www/bestcallcenter/masivosAudios/Test2.wav /usr/local/freeswitch/sounds/es/invalid.wav user_input ^[12]$ 3000"/>
        <action application="export" data="opcion=${user_input}"/>
        <action application="execute_extension" data="procesar_opcion_Test2 XML Test2"/>

        <!-- Segundo intento -->
        <action application="play_and_get_digits" 
                data="1 1 3 3000 # /var/www/bestcallcenter/masivosAudios/Test2.wav /usr/local/freeswitch/sounds/es/invalid.wav user_input ^[12]$ 3000"/>
        <action application="export" data="opcion=${user_input}"/>
        <action application="execute_extension" data="procesar_opcion_Test2 XML Test2"/>

        <!-- Tercer intento -->
          <action application="play_and_get_digits" 
                data="1 1 3 3000 # /var/www/bestcallcenter/masivosAudios/Test2.wav /usr/local/freeswitch/sounds/es/invalid.wav user_input ^[12]$ 3000"/>
        <action application="export" data="opcion=${user_input}"/>
        <action application="execute_extension" data="procesar_opcion_Test2 XML Test2"/>

        <!-- Si no presiona nada -->
        <action application="hangup" data="NORMAL_CLEARING"/>

      </condition>
    </extension>

    <!-- Procesar las opciones -->
    <extension name="procesar_opcion_Test2">

      <!-- Si presiona 1: enviar al otro servidor -->
      <condition field="${opcion}" expression="^1$">
        <action application="bridge" data="sofia/gateway/otro_servidor/2000"/>
      </condition>

      <!-- Si presiona 2: reproducir audio -->
      <condition field="${opcion}" expression="^2$">
        <action application="playback" data="/usr/local/freeswitch/sounds/es/opcion2.wav"/>
      </condition>

      <!-- Si no presiona nada o es inválido: repetir menú -->
      <condition field="${opcion}" expression="^$">
        <action application="transfer" data="1000 XML Test2"/>
      </condition>

    </extension>
  </context>
</include>
